<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>SillyPaintings - Professional Digital Art Studio</title>
Â  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
Â  <style>
Â  Â  /* Reset and Base Styles */
Â  Â  * {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  box-sizing: border-box;
Â  Â  }

Â  Â  body {
Â  Â  Â  font-family: 'Nunito', sans-serif;
Â  Â  Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
Â  Â  Â  color: #fff;
Â  Â  Â  overflow: hidden;
Â  Â  Â  height: 100vh;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }

Â  Â  /* Header */
Â  Â  .header {
Â  Â  Â  background: rgba(0, 0, 0, 0.3);
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
Â  Â  }

Â  Â  .logo {
Â  Â  Â  font-size: 24px;
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #ff6b9d;
Â  Â  Â  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  .header-actions {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 10px;
Â  Â  }

Â  Â  .header-btn {
Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  Â  border: none;
Â  Â  Â  padding: 8px 16px;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  color: white;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 14px;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  }

Â  Â  .header-btn:hover {
Â  Â  Â  background: rgba(255, 255, 255, 0.3);
Â  Â  Â  transform: translateY(-2px);
Â  Â  }

Â  Â  /* Main Layout */
Â  Â  .main-container {
Â  Â  Â  flex: 1;
Â  Â  Â  display: flex;
Â  Â  Â  overflow: hidden;
Â  Â  }

Â  Â  /* Left Sidebar - Tools */
Â  Â  .left-sidebar {
Â  Â  Â  width: 80px;
Â  Â  Â  background: rgba(0, 0, 0, 0.4);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  border-right: 1px solid rgba(255, 255, 255, 0.1);
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 20px 10px;
Â  Â  Â  gap: 15px;
Â  Â  }

Â  Â  .tool-btn {
Â  Â  Â  width: 60px;
Â  Â  Â  height: 60px;
Â  Â  Â  background: rgba(255, 255, 255, 0.1);
Â  Â  Â  border: 2px solid transparent;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  color: white;
Â  Â  Â  font-size: 24px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  }

Â  Â  .tool-btn::before {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: -100%;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
Â  Â  Â  transition: left 0.5s;
Â  Â  }

Â  Â  .tool-btn:hover {
Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  Â  transform: scale(1.05);
Â  Â  }

Â  Â  .tool-btn:hover::before {
Â  Â  Â  left: 100%;
Â  Â  }

Â  Â  .tool-btn.active {
Â  Â  Â  background: #ff6b9d;
Â  Â  Â  border-color: #fff;
Â  Â  Â  box-shadow: 0 0 20px rgba(255, 107, 157, 0.5);
Â  Â  }

Â  Â  /* Canvas Area */
Â  Â  .canvas-area {
Â  Â  Â  flex: 1;
Â  Â  Â  position: relative;
Â  Â  Â  background: #f8f9fa;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  padding: 20px;
Â  Â  }

Â  Â  #canvas-container {
Â  Â  Â  position: relative;
Â  Â  Â  background: white;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
Â  Â  Â  overflow: hidden;
Â  Â  Â  width: calc(100% - 40px);
Â  Â  Â  height: calc(100% - 40px);
Â  Â  Â  max-width: 1200px;
Â  Â  Â  max-height: 800px;
Â  Â  Â  cursor: crosshair;
Â  Â  }

Â  Â  canvas {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100% !important;
Â  Â  Â  height: 100% !important;
Â  Â  Â  touch-action: none;
Â  Â  }

Â  Â  /* Right Sidebar - Properties */
Â  Â  .right-sidebar {
Â  Â  Â  width: 280px;
Â  Â  Â  background: rgba(0, 0, 0, 0.4);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  border-left: 1px solid rgba(255, 255, 255, 0.1);
Â  Â  Â  padding: 20px;
Â  Â  Â  overflow-y: auto;
Â  Â  }

Â  Â  .sidebar-section {
Â  Â  Â  margin-bottom: 30px;
Â  Â  }

Â  Â  .sidebar-title {
Â  Â  Â  font-size: 18px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  color: #ff6b9d;
Â  Â  }

Â  Â  /* Color Picker Section */
Â  Â  .color-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(6, 1fr);
Â  Â  Â  gap: 8px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }

Â  Â  .color-btn {
Â  Â  Â  width: 35px;
Â  Â  Â  height: 35px;
Â  Â  Â  border: 3px solid transparent;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  }

Â  Â  .color-btn:hover {
Â  Â  Â  transform: scale(1.1);
Â  Â  Â  border-color: #fff;
Â  Â  }

Â  Â  .color-btn.active {
Â  Â  Â  border-color: #fff;
Â  Â  Â  box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
Â  Â  }

Â  Â  #colorPicker {
Â  Â  Â  width: 100%;
Â  Â  Â  height: 50px;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  /* Brush Settings */
Â  Â  .slider-container {
Â  Â  Â  margin-bottom: 20px;
Â  Â  }

Â  Â  .slider-label {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  font-size: 14px;
Â  Â  }

Â  Â  .slider {
Â  Â  Â  width: 100%;
Â  Â  Â  height: 6px;
Â  Â  Â  border-radius: 3px;
Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  Â  outline: none;
Â  Â  Â  -webkit-appearance: none;
Â  Â  }

Â  Â  .slider::-webkit-slider-thumb {
Â  Â  Â  appearance: none;
Â  Â  Â  width: 20px;
Â  Â  Â  height: 20px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  background: #ff6b9d;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
Â  Â  }

Â  Â  .slider::-moz-range-thumb {
Â  Â  Â  width: 20px;
Â  Â  Â  height: 20px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  background: #ff6b9d;
Â  Â  Â  cursor: pointer;
Â  Â  Â  border: none;
Â  Â  Â  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
Â  Â  }

Â  Â  /* Advanced brush controls */
Â  Â  .brush-controls {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  Â  gap: 10px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }

Â  Â  .brush-type-btn {
Â  Â  Â  background: rgba(255, 255, 255, 0.1);
Â  Â  Â  border: 2px solid transparent;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  color: white;
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 8px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .brush-type-btn:hover {
Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  }

Â  Â  .brush-type-btn.active {
Â  Â  Â  border-color: #ff6b9d;
Â  Â  Â  background: rgba(255, 107, 157, 0.3);
Â  Â  }

Â  Â  /* Layer Panel */
Â  Â  .layers-panel {
Â  Â  Â  background: rgba(255, 255, 255, 0.1);
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 15px;
Â  Â  }

Â  Â  .layer-item {
Â  Â  Â  background: rgba(255, 255, 255, 0.1);
Â  Â  Â  border-radius: 6px;
Â  Â  Â  padding: 10px;
Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  position: relative;
Â  Â  }

Â  Â  .layer-item::before {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  left: 0;
Â  Â  Â  top: 0;
Â  Â  Â  bottom: 0;
Â  Â  Â  width: 3px;
Â  Â  Â  background: transparent;
Â  Â  Â  transition: background 0.3s ease;
Â  Â  }

Â  Â  .layer-item:hover {
Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  }

Â  Â  .layer-item.active {
Â  Â  Â  background: #ff6b9d;
Â  Â  Â  box-shadow: 0 0 15px rgba(255, 107, 157, 0.3);
Â  Â  }

Â  Â  .layer-item.active::before {
Â  Â  Â  background: #fff;
Â  Â  }

Â  Â  .layer-controls {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 5px;
Â  Â  }

Â  Â  .layer-control-btn {
Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  Â  border: none;
Â  Â  Â  width: 25px;
Â  Â  Â  height: 25px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  color: white;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 12px;
Â  Â  }

Â  Â  .layer-control-btn:hover {
Â  Â  Â  background: rgba(255, 255, 255, 0.4);
Â  Â  }

Â  Â  /* Brush Preview */
Â  Â  .brush-preview {
Â  Â  Â  width: 100%;
Â  Â  Â  height: 60px;
Â  Â  Â  background: white;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  }

Â  Â  .brush-stroke {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 50%;
Â  Â  Â  left: 10%;
Â  Â  Â  right: 10%;
Â  Â  Â  height: 2px;
Â  Â  Â  background: #333;
Â  Â  Â  border-radius: 50px;
Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  transition: all 0.3s ease;
Â  Â  }

Â  Â  /* Pressure sensitivity indicator */
Â  Â  .pressure-indicator {
Â  Â  Â  width: 100%;
Â  Â  Â  height: 20px;
Â  Â  Â  background: rgba(255, 255, 255, 0.1);
Â  Â  Â  border-radius: 10px;
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  }

Â  Â  .pressure-bar {
Â  Â  Â  height: 100%;
Â  Â  Â  background: linear-gradient(90deg, #4ecdc4, #ff6b9d);
Â  Â  Â  border-radius: 10px;
Â  Â  Â  transition: width 0.3s ease;
Â  Â  Â  width: 50%;
Â  Â  }

Â  Â  /* Bottom Toolbar */
Â  Â  .bottom-toolbar {
Â  Â  Â  background: rgba(0, 0, 0, 0.3);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  padding: 10px 20px;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 20px;
Â  Â  Â  border-top: 1px solid rgba(255, 255, 255, 0.1);
Â  Â  }

Â  Â  .zoom-controls {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 10px;
Â  Â  }

Â  Â  .zoom-btn {
Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  Â  border: none;
Â  Â  Â  width: 35px;
Â  Â  Â  height: 35px;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  color: white;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 18px;
Â  Â  }

Â  Â  .zoom-level {
Â  Â  Â  min-width: 60px;
Â  Â  Â  text-align: center;
Â  Â  Â  font-weight: 600;
Â  Â  }

Â  Â  /* Fill tool cursor */
Â  Â  .fill-cursor {
Â  Â  Â  cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="white" stroke="black" d="M10 4l6 6-6 6-6-6z"/></svg>'), auto !important;
Â  Â  }

Â  Â  /* Eraser cursor */
Â  Â  .eraser-cursor {
Â  Â  Â  cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><rect x="2" y="8" width="16" height="8" rx="2" fill="pink" stroke="black"/></svg>'), auto !important;
Â  Â  }

Â  Â  /* Responsive Design */
Â  Â  @media (max-width: 1024px) {
Â  Â  Â  .right-sidebar {
Â  Â  Â  Â  width: 240px;
Â  Â  Â  }
Â  Â  }

Â  Â  @media (max-width: 768px) {
Â  Â  Â  .main-container {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .left-sidebar {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 80px;
Â  Â  Â  Â  flex-direction: row;
Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .right-sidebar {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 200px;
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .tool-btn {
Â  Â  Â  Â  min-width: 60px;
Â  Â  Â  }
Â  Â  }

Â  Â  /* Loading animation */
Â  Â  .loading {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: rgba(0, 0, 0, 0.8);
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  z-index: 1000;
Â  Â  Â  color: white;
Â  Â  Â  font-size: 18px;
Â  Â  }

Â  Â  .loading-spinner {
Â  Â  Â  width: 50px;
Â  Â  Â  height: 50px;
Â  Â  Â  border: 4px solid rgba(255, 255, 255, 0.3);
Â  Â  Â  border-top: 4px solid #ff6b9d;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  Â  margin-right: 15px;
Â  Â  }

Â  Â  @keyframes spin {
Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  }

Â  Â  /* File input styling */
Â  Â  .file-input {
Â  Â  Â  display: none;
Â  Â  }

Â  Â  /* Tool size indicator */
Â  Â  .size-indicator {
Â  Â  Â  position: fixed;
Â  Â  Â  pointer-events: none;
Â  Â  Â  border: 2px solid #ff6b9d;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  background: rgba(255, 107, 157, 0.2);
Â  Â  Â  z-index: 1000;
Â  Â  Â  display: none;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="loading" id="loadingScreen">
Â  Â  <div class="loading-spinner"></div>
Â  Â  Loading your professional art studio...
Â  </div>

Â  <div class="header">
Â  Â  <div class="logo">ğŸ¨ SillyPaintings Studio</div>
Â  Â  <div class="header-actions">
Â  Â  Â  <button class="header-btn" onclick="newProject()">ğŸ†• New</button>
Â  Â  Â  <button class="header-btn" onclick="saveProject()">ğŸ’¾ Save</button>
Â  Â  Â  <button class="header-btn" onclick="loadProject()">ğŸ“‚ Load</button>
Â  Â  Â  <button class="header-btn" onclick="exportPNG()">ğŸ“· Export</button>
Â  Â  </div>
Â  </div>

Â  <div class="main-container">
Â  Â  <div class="left-sidebar">
Â  Â  Â  <button class="tool-btn active" onclick="setTool('brush')" title="Brush" id="brush-tool">
Â  Â  Â  Â  ğŸ–Œï¸
Â  Â  Â  </button>
Â  Â  Â  <button class="tool-btn" onclick="setTool('paintbrush')" title="Paint Brush" id="paintbrush-tool">
Â  Â  Â  Â  ğŸ¨
Â  Â  Â  </button>
Â  Â  Â  <button class="tool-btn" onclick="setTool('pencil')" title="Pencil" id="pencil-tool">
Â  Â  Â  Â  âœï¸
Â  Â  Â  </button>
Â  Â  Â  <button class="tool-btn" onclick="setTool('eraser')" title="Eraser" id="eraser-tool">
Â  Â  Â  Â  ğŸ§¹
Â  Â  Â  </button>
Â  Â  Â  <button class="tool-btn" onclick="setTool('fill')" title="Fill Tool" id="fill-tool">
Â  Â  Â  Â  ğŸª£
Â  Â  Â  </button>
Â  Â  Â  <button class="tool-btn" onclick="setTool('spray')" title="Airbrush" id="spray-tool">
Â  Â  Â  Â  ğŸ’¨
Â  Â  Â  </button>
Â  Â  Â  <button class="tool-btn" onclick="setTool('marker')" title="Marker" id="marker-tool">
Â  Â  Â  Â  ğŸ–ï¸
Â  Â  Â  </button>
Â  Â  Â  <button class="tool-btn" onclick="setTool('smudge')" title="Smudge Tool" id="smudge-tool">
Â  Â  Â  Â  ğŸ‘†
Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div class="canvas-area">
Â  Â  Â  <div id="canvas-container"></div>
Â  Â  Â  <div class="size-indicator" id="sizeIndicator"></div>
Â  Â  </div>

Â  Â  <div class="right-sidebar">
Â  Â  Â  <div class="sidebar-section">
Â  Â  Â  Â  <div class="sidebar-title">ğŸ¨ Colors</div>
Â  Â  Â  Â  <div class="color-grid">
Â  Â  Â  Â  Â  <div class="color-btn active" style="background: #000;" onclick="selectColor('#000000')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #fff;" onclick="selectColor('#ffffff')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #ff0000;" onclick="selectColor('#ff0000')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #00ff00;" onclick="selectColor('#00ff00')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #0000ff;" onclick="selectColor('#0000ff')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #ffff00;" onclick="selectColor('#ffff00')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #ff00ff;" onclick="selectColor('#ff00ff')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #00ffff;" onclick="selectColor('#00ffff')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #ffa500;" onclick="selectColor('#ffa500')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #800080;" onclick="selectColor('#800080')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #ffc0cb;" onclick="selectColor('#ffc0cb')"></div>
Â  Â  Â  Â  Â  <div class="color-btn" style="background: #90ee90;" onclick="selectColor('#90ee90')"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input type="color" id="colorPicker" value="#000000" onchange="selectColor(this.value)">
Â  Â  Â  </div>

Â  Â  Â  <div class="sidebar-section">
Â  Â  Â  Â  <div class="sidebar-title">ğŸ–Œï¸ Tool Settings</div>
Â  Â  Â  Â  <div class="brush-preview">
Â  Â  Â  Â  Â  <div class="brush-stroke" id="brushPreview"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="brush-controls">
Â  Â  Â  Â  Â  <button class="brush-type-btn active" onclick="setBrushType('normal')" id="normal-brush">Normal</button>
Â  Â  Â  Â  Â  <button class="brush-type-btn" onclick="setBrushType('texture')" id="texture-brush">Textured</button>
Â  Â  Â  Â  Â  <button class="brush-type-btn" onclick="setBrushType('soft')" id="soft-brush">Soft</button>
Â  Â  Â  Â  Â  <button class="brush-type-btn" onclick="setBrushType('hard')" id="hard-brush">Hard</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="slider-container">
Â  Â  Â  Â  Â  <div class="slider-label">
Â  Â  Â  Â  Â  Â  <span>Size</span>
Â  Â  Â  Â  Â  Â  <span id="sizeValue">10</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <input type="range" class="slider" id="brushSize" min="1" max="200" value="10" oninput="updateBrushSize(this.value)">
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="slider-container">
Â  Â  Â  Â  Â  <div class="slider-label">
Â  Â  Â  Â  Â  Â  <span>Opacity</span>
Â  Â  Â  Â  Â  Â  <span id="opacityValue">100%</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <input type="range" class="slider" id="brushOpacity" min="1" max="100" value="100" oninput="updateOpacity(this.value)">
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="slider-container">
Â  Â  Â  Â  Â  <div class="slider-label">
Â  Â  Â  Â  Â  Â  <span>Flow</span>
Â  Â  Â  Â  Â  Â  <span id="flowValue">100%</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <input type="range" class="slider" id="brushFlow" min="1" max="100" value="100" oninput="updateFlow(this.value)">
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="slider-container">
Â  Â  Â  Â  Â  <div class="slider-label">
Â  Â  Â  Â  Â  Â  <span>Hardness</span>
Â  Â  Â  Â  Â  Â  <span id="hardnessValue">100%</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <input type="range" class="slider" id="brushHardness" min="0" max="100" value="100" oninput="updateHardness(this.value)">
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="pressure-indicator" title="Brush Pressure">
Â  Â  Â  Â  Â  <div class="pressure-bar" id="pressureBar"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="sidebar-section">
Â  Â  Â  Â  <div class="sidebar-title">ğŸ“š Layers</div>
Â  Â  Â  Â  <div class="layers-panel" id="layersPanel">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="header-btn" onclick="addLayer()" style="width: 100%; margin-top: 10px;">â• Add Layer</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="bottom-toolbar">
Â  Â  <div class="zoom-controls">
Â  Â  Â  <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">-</button>
Â  Â  Â  <div class="zoom-level" id="zoomLevel">100%</div>
Â  Â  Â  <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
Â  Â  </div>
Â  Â  <button class="header-btn" onclick="undoAction()" title="Undo">â†¶ Undo</button>
Â  Â  <button class="header-btn" onclick="redoAction()" title="Redo">â†· Redo</button>
Â  Â  <button class="header-btn" onclick="clearCurrentLayer()" title="Clear Layer">ğŸ§¼ Clear</button>
Â  </div>

Â  <input type="file" id="fileInput" class="file-input" accept=".json" onchange="handleFileLoad(event)">

Â  <script>
Â  Â  // Global variables
Â  Â  let canvases = [];
Â  Â  let currentLayerIndex = 0;
Â  Â  let currentTool = 'brush';
Â  Â  let currentBrushType = 'normal';
Â  Â  let currentColor = '#000000';
Â  Â  let currentSize = 10;
Â  Â  let currentOpacity = 1.0;
Â  Â  let currentFlow = 1.0;
Â  Â  let currentHardness = 1.0;
Â  Â  let zoomLevel = 1.0;
Â  Â  let isDrawing = false;
Â  Â  let undoStack = [];
Â  Â  let redoStack = [];
Â  Â  let pressureSimulation = 0.5;
Â  Â  let isMouseDown = false;
Â  Â Â 
Â  Â  // Canvas settings
Â  Â  const CANVAS_WIDTH = 1200;
Â  Â  const CANVAS_HEIGHT = 800;
Â  Â  const MAX_LAYERS = 10;

Â  Â  // Initialize the application
Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  initializeApp();
Â  Â  Â  Â  document.getElementById('loadingScreen').style.display = 'none';
Â  Â  Â  }, 1500);
Â  Â  });

Â  Â  function initializeApp() {
Â  Â  Â  createInitialLayers();
Â  Â  Â  setupCanvasContainer();
Â  Â  Â  updateLayersPanel();
Â  Â  Â  updateBrushPreview();
Â  Â  Â  setupEventListeners();
Â  Â  Â  saveState(); // Save the initial empty state
Â  Â  }

Â  Â  function setupEventListeners() {
Â  Â  Â  // Window resize handler
Â  Â  Â  window.addEventListener('resize', () => {
Â  Â  Â  Â  canvases.forEach(canvas => {
Â  Â  Â  Â  Â  resizeCanvas(canvas);
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  // Mouse move for size indicator
Â  Â  Â  document.addEventListener('mousemove', updateSizeIndicator);

Â  Â  Â  // Keyboard shortcuts
Â  Â  Â  document.addEventListener('keydown', (e) => {
Â  Â  Â  Â  if (e.ctrlKey || e.metaKey) {
Â  Â  Â  Â  Â  switch (e.key) {
Â  Â  Â  Â  Â  Â  case 'z':
Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  if (e.shiftKey) {
Â  Â  Â  Â  Â  Â  Â  Â  redoAction();
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  undoAction();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case 'n':
Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  newProject();
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case 's':
Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  saveProject();
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Tool shortcuts
Â  Â  Â  Â  switch (e.key) {
Â  Â  Â  Â  Â  case 'b':
Â  Â  Â  Â  Â  Â  setTool('brush');
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case 'p':
Â  Â  Â  Â  Â  Â  if (!e.ctrlKey && !e.metaKey) setTool('paintbrush');
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case 'e':
Â  Â  Â  Â  Â  Â  if (!e.ctrlKey && !e.metaKey) setTool('eraser');
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case 'f':
Â  Â  Â  Â  Â  Â  setTool('fill');
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case 's':
Â  Â  Â  Â  Â  Â  if (!e.ctrlKey && !e.metaKey) setTool('spray');
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case 'm':
Â  Â  Â  Â  Â  Â  setTool('marker');
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case '1':
Â  Â  Â  Â  Â  case '2':
Â  Â  Â  Â  Â  case '3':
Â  Â  Â  Â  Â  case '4':
Â  Â  Â  Â  Â  Â  const brushTypes = ['normal', 'texture', 'soft', 'hard'];
Â  Â  Â  Â  Â  Â  const brushType = brushTypes[parseInt(e.key) - 1];
Â  Â  Â  Â  Â  Â  if (brushType) setBrushType(brushType);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case '[':
Â  Â  Â  Â  Â  Â  // Decrease brush size
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const newSizeDown = Math.max(1, currentSize - 5);
Â  Â  Â  Â  Â  Â  updateBrushSize(newSizeDown);
Â  Â  Â  Â  Â  Â  document.getElementById('brushSize').value = newSizeDown;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case ']':
Â  Â  Â  Â  Â  Â  // Increase brush size
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const newSizeUp = Math.min(200, currentSize + 5);
Â  Â  Â  Â  Â  Â  updateBrushSize(newSizeUp);
Â  Â  Â  Â  Â  Â  document.getElementById('brushSize').value = newSizeUp;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  function updateSizeIndicator(e) {
Â  Â  Â  const indicator = document.getElementById('sizeIndicator');
Â  Â  Â  const canvasContainer = document.getElementById('canvas-container');
Â  Â  Â  const containerRect = canvasContainer.getBoundingClientRect();
Â  Â  Â Â 
Â  Â  Â  // Only show indicator when hovering over canvas
Â  Â  Â  if (e.clientX >= containerRect.left && e.clientX <= containerRect.right &&
Â  Â  Â  Â  Â  e.clientY >= containerRect.top && e.clientY <= containerRect.bottom) {
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (currentTool === 'brush' || currentTool === 'paintbrush' ||Â 
Â  Â  Â  Â  Â  Â  currentTool === 'pencil' || currentTool === 'eraser' ||Â 
Â  Â  Â  Â  Â  Â  currentTool === 'spray' || currentTool === 'marker') {
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const size = currentSize * (containerRect.width / CANVAS_WIDTH) * zoomLevel;
Â  Â  Â  Â  Â  indicator.style.width = size + 'px';
Â  Â  Â  Â  Â  indicator.style.height = size + 'px';
Â  Â  Â  Â  Â  indicator.style.left = (e.clientX - size / 2) + 'px';
Â  Â  Â  Â  Â  indicator.style.top = (e.clientY - size / 2) + 'px';
Â  Â  Â  Â  Â  indicator.style.display = 'block';
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Change indicator color for eraser
Â  Â  Â  Â  Â  if (currentTool === 'eraser') {
Â  Â  Â  Â  Â  Â  indicator.style.borderColor = '#ff4444';
Â  Â  Â  Â  Â  Â  indicator.style.background = 'rgba(255, 68, 68, 0.2)';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  indicator.style.borderColor = '#ff6b9d';
Â  Â  Â  Â  Â  Â  indicator.style.background = 'rgba(255, 107, 157, 0.2)';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  indicator.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  indicator.style.display = 'none';
Â  Â  Â  }
Â  Â  }

Â  Â  function createInitialLayers() {
Â  Â  Â  // Create 3 initial layers
Â  Â  Â  for (let i = 0; i < 3; i++) {
Â  Â  Â  Â  createLayer(i);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Set first layer as active
Â  Â  Â  setActiveLayer(0);
Â  Â  }

Â  Â  function createLayer(index) {
Â  Â  Â  const container = document.getElementById('canvas-container');
Â  Â  Â  const canvasEl = document.createElement('canvas');
Â  Â  Â Â 
Â  Â  Â  canvasEl.id = `canvas-${index}`;
Â  Â  Â  canvasEl.style.position = 'absolute';
Â  Â  Â  canvasEl.style.top = '0';
Â  Â  Â  canvasEl.style.left = '0';
Â  Â  Â  canvasEl.style.zIndex = index;
Â  Â  Â Â 
Â  Â  Â  container.appendChild(canvasEl);
Â  Â  Â Â 
Â  Â  Â  const fabricCanvas = new fabric.Canvas(canvasEl, {
Â  Â  Â  Â  width: CANVAS_WIDTH,
Â  Â  Â  Â  height: CANVAS_HEIGHT,
Â  Â  Â  Â  backgroundColor: index === 0 ? '#ffffff' : 'transparent'
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  // Configure drawing settings
Â  Â  Â  fabricCanvas.freeDrawingBrush.width = currentSize;
Â  Â  Â  fabricCanvas.freeDrawingBrush.color = currentColor;
Â  Â  Â  fabricCanvas.isDrawingMode = false;
Â  Â  Â Â 
Â  Â  Â  // Add drawing event listeners for undo/redo
Â  Â  Â  fabricCanvas.on('path:created', function() {
Â  Â  Â  Â  saveState();
Â  Â  Â  });

Â  Â  Â  // Add fill tool click handler
Â  Â  Â  fabricCanvas.on('mouse:down', function(options) {
Â  Â  Â  Â  if (currentTool === 'fill') {
Â  Â  Â  Â  Â  handleFillClick(options, fabricCanvas);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  canvases[index] = fabricCanvas;
Â  Â  Â Â 
Â  Â  Â  // Resize canvas to fit container
Â  Â  Â  resizeCanvas(fabricCanvas);
Â  Â  }

Â  Â  function setupCanvasContainer() {
Â  Â  Â  const container = document.getElementById('canvas-container');
Â  Â  Â Â 
Â  Â  Â  // Make sure all canvases fit the container
Â  Â  Â  canvases.forEach(canvas => {
Â  Â  Â  Â  resizeCanvas(canvas);
Â  Â  Â  });
Â  Â  }

Â  Â  function resizeCanvas(canvas) {
Â  Â  Â  const container = document.getElementById('canvas-container');
Â  Â  Â  const containerRect = container.getBoundingClientRect();
Â  Â  Â Â 
Â  Â  Â  const scaleX = containerRect.width / CANVAS_WIDTH;
Â  Â  Â  const scaleY = containerRect.height / CANVAS_HEIGHT;
Â  Â  Â  const scale = Math.min(scaleX, scaleY);
Â  Â  Â Â 
Â  Â  Â  canvas.setDimensions({
Â  Â  Â  Â  width: CANVAS_WIDTH * scale,
Â  Â  Â  Â  height: CANVAS_HEIGHT * scale
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  canvas.setZoom(scale * zoomLevel);
Â  Â  }

Â  Â  // Tool functions
Â  Â  function setTool(tool) {
Â  Â  Â  // Remove active class from all tools
Â  Â  Â  document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
Â  Â  Â Â 
Â  Â  Â  // Add active class to selected tool
Â  Â  Â  const toolBtn = document.getElementById(`${tool}-tool`);
Â  Â  Â  if (toolBtn) toolBtn.classList.add('active');
Â  Â  Â Â 
Â  Â  Â  currentTool = tool;
Â  Â  Â  updateCurrentCanvas();
Â  Â  Â  updateCursor();
Â  Â  }

Â  Â  function updateCursor() {
Â  Â  Â  const container = document.getElementById('canvas-container');
Â  Â  Â Â 
Â  Â  Â  // Remove all cursor classes
Â  Â  Â  container.classList.remove('fill-cursor', 'eraser-cursor');
Â  Â  Â Â 
Â  Â  Â  switch (currentTool) {
Â  Â  Â  Â  case 'fill':
Â  Â  Â  Â  Â  container.classList.add('fill-cursor');
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'eraser':
Â  Â  Â  Â  Â  container.classList.add('eraser-cursor');
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  container.style.cursor = 'crosshair';
Â  Â  Â  }
Â  Â  }

Â  Â  function updateCurrentCanvas() {
Â  Â  Â  const activeCanvas = canvases[currentLayerIndex];
Â  Â  Â  if (!activeCanvas) return;
Â  Â  Â Â 
Â  Â  Â  switch (currentTool) {
Â  Â  Â  Â  case 'brush':
Â  Â  Â  Â  Â  activeCanvas.isDrawingMode = true;
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush = new fabric.PencilBrush(activeCanvas);
Â  Â  Â  Â  Â  setupBrushSettings(activeCanvas);
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  case 'paintbrush':
Â  Â  Â  Â  Â  activeCanvas.isDrawingMode = true;
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush = createAdvancedBrush(activeCanvas);
Â  Â  Â  Â  Â  setupPaintBrushSettings(activeCanvas);
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  case 'pencil':
Â  Â  Â  Â  Â  activeCanvas.isDrawingMode = true;
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush = new fabric.PencilBrush(activeCanvas);
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.width = Math.max(1, currentSize * 0.3);
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.color = currentColor;
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.globalCompositeOperation = 'source-over';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  case 'eraser':
Â  Â  Â  Â  Â  activeCanvas.isDrawingMode = true;
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush = new fabric.EraserBrush(activeCanvas);
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.width = currentSize;
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  case 'fill':
Â  Â  Â  Â  Â  activeCanvas.isDrawingMode = false;
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  case 'spray':
Â  Â  Â  Â  Â  activeCanvas.isDrawingMode = true;
Â  Â  Â  Â  Â  if (fabric.SprayBrush) {
Â  Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush = new fabric.SprayBrush(activeCanvas);
Â  Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.width = currentSize * 1.5;
Â  Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.color = hexToRgba(currentColor, currentOpacity * currentFlow);
Â  Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.density = Math.max(5, 30 - (currentHardness * 0.25));
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush = new fabric.PencilBrush(activeCanvas);
Â  Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.width = currentSize;
Â  Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.color = hexToRgba(currentColor, currentOpacity * currentFlow);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  case 'marker':
Â  Â  Â  Â  Â  activeCanvas.isDrawingMode = true;
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush = new fabric.PencilBrush(activeCanvas);
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.width = currentSize * 1.2;
Â  Â  Â  Â  Â  activeCanvas.freeDrawingBrush.color = hexToRgba(currentColor, 0.7 * currentOpacity);
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  case 'smudge':
Â  Â  Â  Â  Â  activeCanvas.isDrawingMode = false;
Â  Â  Â  Â  Â  alert('Smudge tool coming soon! ğŸ¨');
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  activeCanvas.isDrawingMode = false;
Â  Â  Â  }
Â  Â  }

Â  Â  function setupBrushSettings(canvas) {
Â  Â  Â  canvas.freeDrawingBrush.width = currentSize;
Â  Â  Â  canvas.freeDrawingBrush.color = hexToRgba(currentColor, currentOpacity * currentFlow);
Â  Â  Â  canvas.freeDrawingBrush.globalCompositeOperation = 'source-over';
Â  Â  }

Â  Â  function createAdvancedBrush(canvas) {
Â  Â  Â  const brush = new fabric.PencilBrush(canvas);
Â  Â  Â  return brush;
Â  Â  }

Â  Â  function setupPaintBrushSettings(canvas) {
Â  Â  Â  const brush = canvas.freeDrawingBrush;
Â  Â  Â  const effectiveSize = currentSize * (0.8 + (pressureSimulation * 0.4));
Â  Â  Â  const effectiveOpacity = currentOpacity * currentFlow * (0.7 + (pressureSimulation * 0.3));
Â  Â  Â Â 
Â  Â  Â  brush.width = effectiveSize;
Â  Â  Â  brush.color = hexToRgba(currentColor, effectiveOpacity);
Â  Â  Â Â 
Â  Â  Â  // Apply brush type effects
Â  Â  Â  switch (currentBrushType) {
Â  Â  Â  Â  case 'soft':
Â  Â  Â  Â  Â  brush.shadowBlur = Math.max(2, currentSize * 0.3 * (1 - currentHardness));
Â  Â  Â  Â  Â  brush.shadowColor = hexToRgba(currentColor, effectiveOpacity * 0.5);
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'hard':
Â  Â  Â  Â  Â  brush.shadowBlur = 0;
Â  Â  Â  Â  Â  brush.shadowColor = 'transparent';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'texture':
Â  Â  Â  Â  Â  brush.width = effectiveSize * (0.9 + Math.random() * 0.2);
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  brush.shadowBlur = Math.max(1, currentSize * 0.1 * (1 - currentHardness));
Â  Â  Â  Â  Â  brush.shadowColor = hexToRgba(currentColor, effectiveOpacity * 0.3);
Â  Â  Â  }
Â  Â  }

Â  Â  // Fill tool implementation
Â  Â  function handleFillClick(options, canvas) {
Â  Â  Â  const pointer = canvas.getPointer(options.e);
Â  Â  Â  const x = Math.floor(pointer.x);
Â  Â  Â  const y = Math.floor(pointer.y);
Â  Â  Â Â 
Â  Â  Â  // Get canvas context for pixel manipulation
Â  Â  Â  const ctx = canvas.getContext();
Â  Â  Â  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
Â  Â  Â  const pixelData = imageData.data;
Â  Â  Â Â 
Â  Â  Â  // Get target color at click position
Â  Â  Â  const targetColor = getPixelColor(pixelData, x, y, canvas.width);
Â  Â  Â  const fillColor = hexToRgb(currentColor);
Â  Â  Â Â 
Â  Â  Â  // Don't fill if target and fill colors are the same
Â  Â  Â  if (colorsEqual(targetColor, fillColor)) return;
Â  Â  Â Â 
Â  Â  Â  // Perform flood fill
Â  Â  Â  floodFill(pixelData, x, y, targetColor, fillColor, canvas.width, canvas.height);
Â  Â  Â Â 
Â  Â  Â  // Apply the changes
Â  Â  Â  ctx.putImageData(imageData, 0, 0);
Â  Â  Â  canvas.renderAll();
Â  Â  Â Â 
Â  Â  Â  // Save state for undo
Â  Â  Â  saveState();
Â  Â  }

Â  Â  function getPixelColor(pixelData, x, y, width) {
Â  Â  Â  const index = (y * width + x) * 4;
Â  Â  Â  return {
Â  Â  Â  Â  r: pixelData[index],
Â  Â  Â  Â  g: pixelData[index + 1],
Â  Â  Â  Â  b: pixelData[index + 2],
Â  Â  Â  Â  a: pixelData[index + 3]
Â  Â  Â  };
Â  Â  }

Â  Â  function setPixelColor(pixelData, x, y, width, color) {
Â  Â  Â  const index = (y * width + x) * 4;
Â  Â  Â  pixelData[index] = color.r;
Â  Â  Â  pixelData[index + 1] = color.g;
Â  Â  Â  pixelData[index + 2] = color.b;
Â  Â  Â  pixelData[index + 3] = color.a || 255;
Â  Â  }

Â  Â  function colorsEqual(color1, color2) {
Â  Â  Â  return color1.r === color2.r &&Â 
Â  Â  Â  Â  Â  Â  Â color1.g === color2.g &&Â 
Â  Â  Â  Â  Â  Â  Â color1.b === color2.b &&Â 
Â  Â  Â  Â  Â  Â  Â color1.a === color2.a;
Â  Â  }

Â  Â  function floodFill(pixelData, startX, startY, targetColor, fillColor, width, height) {
Â  Â  Â  const stack = [[startX, startY]];
Â  Â  Â  const visited = new Set();

Â  Â  Â  while (stack.length > 0) {
Â  Â  Â  Â  const [x, y] = stack.pop();
Â  Â  Â  Â  if (x < 0 || x >= width || y < 0 || y >= height || visited.has(`${x},${y}`)) {
Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }

Â  Â  Â  Â  const currentColor = getPixelColor(pixelData, x, y, width);
Â  Â  Â  Â  if (colorsEqual(currentColor, targetColor)) {
Â  Â  Â  Â  Â  setPixelColor(pixelData, x, y, width, fillColor);
Â  Â  Â  Â  Â  visited.add(`${x},${y}`);
Â  Â  Â  Â  Â  stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  // Undo/Redo functions
Â  Â  function saveState() {
Â  Â  Â  if (canvases[currentLayerIndex]) {
Â  Â  Â  Â  const state = canvases[currentLayerIndex].toJSON();
Â  Â  Â  Â  undoStack.push(state);
Â  Â  Â  Â  redoStack = []; // Clear redo stack on new action
Â  Â  Â  }
Â  Â  }

Â  Â  function undoAction() {
Â  Â  Â  if (undoStack.length > 1) { // Keep at least one state for the current view
Â  Â  Â  Â  const currentState = undoStack.pop();
Â  Â  Â  Â  redoStack.push(currentState);
Â  Â  Â  Â  const previousState = undoStack[undoStack.length - 1];
Â  Â  Â  Â  canvases[currentLayerIndex].loadFromJSON(previousState, () => {
Â  Â  Â  Â  Â  canvases[currentLayerIndex].renderAll();
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }

Â  Â  function redoAction() {
Â  Â  Â  if (redoStack.length > 0) {
Â  Â  Â  Â  const nextState = redoStack.pop();
Â  Â  Â  Â  undoStack.push(nextState);
Â  Â  Â  Â  canvases[currentLayerIndex].loadFromJSON(nextState, () => {
Â  Â  Â  Â  Â  canvases[currentLayerIndex].renderAll();
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }

Â  Â  // Color functions
Â  Â  function selectColor(color) {
Â  Â  Â  currentColor = color;
Â  Â  Â  document.getElementById('colorPicker').value = color;
Â  Â  Â  document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
Â  Â  Â  const selectedBtn = Array.from(document.querySelectorAll('.color-btn')).find(btn => btn.style.background === color);
Â  Â  Â  if (selectedBtn) selectedBtn.classList.add('active');
Â  Â  Â  updateCurrentCanvas();
Â  Â  }

Â  Â  function hexToRgba(hex, alpha) {
Â  Â  Â  const r = parseInt(hex.slice(1, 3), 16);
Â  Â  Â  const g = parseInt(hex.slice(3, 5), 16);
Â  Â  Â  const b = parseInt(hex.slice(5, 7), 16);
Â  Â  Â  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
Â  Â  }

Â  Â  function hexToRgb(hex) {
Â  Â  Â  const r = parseInt(hex.slice(1, 3), 16);
Â  Â  Â  const g = parseInt(hex.slice(3, 5), 16);
Â  Â  Â  const b = parseInt(hex.slice(5, 7), 16);
Â  Â  Â  return {r, g, b, a: 255};
Â  Â  }

Â  Â  // Brush settings functions
Â  Â  function setBrushType(type) {
Â  Â  Â  document.querySelectorAll('.brush-type-btn').forEach(btn => btn.classList.remove('active'));
Â  Â  Â  document.getElementById(`${type}-brush`).classList.add('active');
Â  Â  Â  currentBrushType = type;
Â  Â  Â  updateCurrentCanvas();
Â  Â  }

Â  Â  function updateBrushSize(size) {
Â  Â  Â  currentSize = parseInt(size);
Â  Â  Â  document.getElementById('sizeValue').textContent = currentSize;
Â  Â  Â  updateBrushPreview();
Â  Â  Â  updateCurrentCanvas();
Â  Â  }

Â  Â  function updateOpacity(opacity) {
Â  Â  Â  currentOpacity = parseInt(opacity) / 100;
Â  Â  Â  document.getElementById('opacityValue').textContent = `${parseInt(opacity)}%`;
Â  Â  Â  updateBrushPreview();
Â  Â  Â  updateCurrentCanvas();
Â  Â  }

Â  Â  function updateFlow(flow) {
Â  Â  Â  currentFlow = parseInt(flow) / 100;
Â  Â  Â  document.getElementById('flowValue').textContent = `${parseInt(flow)}%`;
Â  Â  Â  updateBrushPreview();
Â  Â  Â  updateCurrentCanvas();
Â  Â  }

Â  Â  function updateHardness(hardness) {
Â  Â  Â  currentHardness = parseInt(hardness) / 100;
Â  Â  Â  document.getElementById('hardnessValue').textContent = `${parseInt(hardness)}%`;
Â  Â  Â  updateBrushPreview();
Â  Â  Â  updateCurrentCanvas();
Â  Â  }

Â  Â  function updateBrushPreview() {
Â  Â  Â  const preview = document.getElementById('brushPreview');
Â  Â  Â  preview.style.height = `${currentSize}px`;
Â  Â  Â  preview.style.background = hexToRgba(currentColor, currentOpacity);
Â  Â  Â  preview.style.opacity = currentFlow;
Â  Â  Â  preview.style.boxShadow = `0 0 ${currentSize * (1 - currentHardness) * 0.5}px ${hexToRgba(currentColor, currentOpacity)}`;
Â  Â  Â  preview.style.borderRadius = '50px';
Â  Â  }

Â  Â  // Layer functions
Â  Â  function addLayer() {
Â  Â  Â  if (canvases.length >= MAX_LAYERS) {
Â  Â  Â  Â  alert('Maximum number of layers reached!');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const newIndex = canvases.length;
Â  Â  Â  createLayer(newIndex);
Â  Â  Â  setActiveLayer(newIndex);
Â  Â  Â  updateLayersPanel();
Â  Â  Â  saveState(); // Save state after adding layer
Â  Â  }

Â  Â  function setActiveLayer(index) {
Â  Â  Â  currentLayerIndex = index;
Â  Â  Â  canvases.forEach((canvas, i) => {
Â  Â  Â  Â  canvas.isDrawingMode = (i === index);
Â  Â  Â  Â  canvas.freeDrawingBrush.width = currentSize;
Â  Â  Â  Â  canvas.freeDrawingBrush.color = hexToRgba(currentColor, currentOpacity * currentFlow);
Â  Â  Â  });
Â  Â  Â  updateLayersPanel();
Â  Â  }

Â  Â  function updateLayersPanel() {
Â  Â  Â  const layersPanel = document.getElementById('layersPanel');
Â  Â  Â  layersPanel.innerHTML = '';
Â  Â  Â  canvases.forEach((canvas, index) => {
Â  Â  Â  Â  const layerItem = document.createElement('div');
Â  Â  Â  Â  layerItem.className = 'layer-item';
Â  Â  Â  Â  if (index === currentLayerIndex) {
Â  Â  Â  Â  Â  layerItem.classList.add('active');
Â  Â  Â  Â  }
Â  Â  Â  Â  layerItem.onclick = () => setActiveLayer(index);
Â  Â  Â  Â  layerItem.innerHTML = `
Â  Â  Â  Â  Â  <span>Layer ${index + 1}</span>
Â  Â  Â  Â  Â  <div class="layer-controls">
Â  Â  Â  Â  Â  Â  <button class="layer-control-btn" onclick="toggleVisibility(event, ${index})">ğŸ‘ï¸</button>
Â  Â  Â  Â  Â  Â  <button class="layer-control-btn" onclick="deleteLayer(event, ${index})">ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  layersPanel.appendChild(layerItem);
Â  Â  Â  });
Â  Â  }

Â  Â  function toggleVisibility(event, index) {
Â  Â  Â  event.stopPropagation();
Â  Â  Â  const canvasEl = canvases[index].getElement();
Â  Â  Â  canvasEl.style.display = canvasEl.style.display === 'none' ? 'block' : 'none';
Â  Â  }

Â  Â  function deleteLayer(event, index) {
Â  Â  Â  event.stopPropagation();
Â  Â  Â  if (canvases.length <= 1) {
Â  Â  Â  Â  alert("You can't delete the last layer!");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const canvasToRemove = canvases[index].getElement();
Â  Â  Â  canvasToRemove.remove();
Â  Â  Â  canvases.splice(index, 1);
Â  Â  Â Â 
Â  Â  Â  if (currentLayerIndex >= canvases.length) {
Â  Â  Â  Â  currentLayerIndex = canvases.length - 1;
Â  Â  Â  }
Â  Â  Â  setActiveLayer(currentLayerIndex);
Â  Â  Â  updateLayersPanel();
Â  Â  Â  saveState(); // Save state after deleting layer
Â  Â  }

Â  Â  function clearCurrentLayer() {
Â  Â  Â  if (canvases[currentLayerIndex]) {
Â  Â  Â  Â  canvases[currentLayerIndex].clear();
Â  Â  Â  Â  canvases[currentLayerIndex].backgroundColor = currentLayerIndex === 0 ? '#ffffff' : 'transparent';
Â  Â  Â  Â  canvases[currentLayerIndex].renderAll();
Â  Â  Â  Â  saveState(); // Save state after clearing layer
Â  Â  Â  }
Â  Â  }

Â  Â  // File/Project Management functions
Â  Â  function newProject() {
Â  Â  Â  if (confirm("Are you sure you want to start a new project? All unsaved changes will be lost.")) {
Â  Â  Â  Â  canvases.forEach(canvas => canvas.dispose());
Â  Â  Â  Â  canvases = [];
Â  Â  Â  Â  undoStack = [];
Â  Â  Â  Â  redoStack = [];
Â  Â  Â  Â  createInitialLayers();
Â  Â  Â  Â  saveState();
Â  Â  Â  }
Â  Â  }

Â  Â  function saveProject() {
Â  Â  Â  const projectData = {
Â  Â  Â  Â  layers: canvases.map(canvas => canvas.toJSON()),
Â  Â  Â  Â  currentLayerIndex: currentLayerIndex
Â  Â  Â  };
Â  Â  Â  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData));
Â  Â  Â  const downloadAnchorNode = document.createElement('a');
Â  Â  Â  downloadAnchorNode.setAttribute("href", dataStr);
Â  Â  Â  downloadAnchorNode.setAttribute("download", "sillypainting.json");
Â  Â  Â  document.body.appendChild(downloadAnchorNode);
Â  Â  Â  downloadAnchorNode.click();
Â  Â  Â  downloadAnchorNode.remove();
Â  Â  }

Â  Â  function loadProject() {
Â  Â  Â  document.getElementById('fileInput').click();
Â  Â  }

Â  Â  function handleFileLoad(event) {
Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  if (!file) return;
Â  Â  Â  const reader = new FileReader();
Â  Â  Â  reader.onload = function(e) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const projectData = JSON.parse(e.target.result);
Â  Â  Â  Â  Â  loadFromProjectData(projectData);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  alert("Error loading project file. Please ensure it's a valid JSON file.");
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  reader.readAsText(file);
Â  Â  }

Â  Â  function loadFromProjectData(projectData) {
Â  Â  Â  canvases.forEach(canvas => canvas.dispose());
Â  Â  Â  canvases = [];
Â  Â  Â  undoStack = [];
Â  Â  Â  redoStack = [];
Â  Â  Â Â 
Â  Â  Â  const container = document.getElementById('canvas-container');
Â  Â  Â  container.innerHTML = '';
Â  Â  Â Â 
Â  Â  Â  projectData.layers.forEach((layer, index) => {
Â  Â  Â  Â  createLayer(index);
Â  Â  Â  Â  canvases[index].loadFromJSON(layer, () => {
Â  Â  Â  Â  Â  canvases[index].renderAll();
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  setActiveLayer(projectData.currentLayerIndex);
Â  Â  Â  updateLayersPanel();
Â  Â  Â  saveState(); // Save the newly loaded state
Â  Â  }

Â  Â  function exportPNG() {
Â  Â  Â  // Merge all canvases into a single one for export
Â  Â  Â  const mergedCanvas = new fabric.StaticCanvas(null, {
Â  Â  Â  Â  width: CANVAS_WIDTH,
Â  Â  Â  Â  height: CANVAS_HEIGHT
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  let drawPromises = canvases.map(canvas => {
Â  Â  Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  Â  img.onload = () => {
Â  Â  Â  Â  Â  Â  mergedCanvas.getContext().drawImage(img, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  img.src = canvas.toDataURL({
Â  Â  Â  Â  Â  Â  format: 'png',
Â  Â  Â  Â  Â  Â  multiplier: 1 / canvas.getZoom()
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  Promise.all(drawPromises).then(() => {
Â  Â  Â  Â  const dataURL = mergedCanvas.toDataURL({
Â  Â  Â  Â  Â  format: 'png'
Â  Â  Â  Â  });
Â  Â  Â  Â  const downloadLink = document.createElement('a');
Â  Â  Â  Â  downloadLink.href = dataURL;
Â  Â  Â  Â  downloadLink.download = 'sillypainting_export.png';
Â  Â  Â  Â  document.body.appendChild(downloadLink);
Â  Â  Â  Â  downloadLink.click();
Â  Â  Â  Â  document.body.removeChild(downloadLink);
Â  Â  Â  });
Â  Â  }

Â  Â  // Zoom functions
Â  Â  function zoomIn() {
Â  Â  Â  zoomLevel = Math.min(zoomLevel + 0.1, 3.0);
Â  Â  Â  updateZoom();
Â  Â  }
Â  Â Â 
Â  Â  function zoomOut() {
Â  Â  Â  zoomLevel = Math.max(zoomLevel - 0.1, 0.1);
Â  Â  Â  updateZoom();
Â  Â  }

Â  Â  function updateZoom() {
Â  Â  Â  document.getElementById('zoomLevel').textContent = `${Math.round(zoomLevel * 100)}%`;
Â  Â  Â  canvases.forEach(canvas => {
Â  Â  Â  Â  resizeCanvas(canvas);
Â  Â  Â  });
Â  Â  }
Â  </script>
</body>
</html>
